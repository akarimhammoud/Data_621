---
title: "DATA 621 Final Project"
author: "Group 2"
---

### Overview
There are millions of stray pets around the world, some of which are fortunate enough to be adopted while many others are not.  While adoption of a pet is often the definition of success, the rate at which a pet is adopted is also a key success factor - pets that take a long time to adopt contribute to over-crowded animal shelters and can prevent taking on new strays.  Sadly, pets that are not adopted eventually need to be euthanized.

### Learn more about the data
[About the data](https://www.kaggle.com/c/petfinder-adoption-prediction/data)

- PetID - Unique hash ID of pet profile
- AdoptionSpeed - **response variable** Categorical speed of adoption. Lower is faster. 
- Type - Type of animal (1 = Dog, 2 = Cat)
- Name - Name of pet (Empty if not named)
- Age - Age of pet when listed, in months
- Breed1 - Primary breed of pet (Refer to BreedLabels dictionary)
- Breed2 - Secondary breed of pet, if pet is of mixed breed (Refer to BreedLabels dictionary)
- Gender - Gender of pet (1 = Male, 2 = Female, 3 = Mixed, if profile represents group of pets)
- Color1 - Color 1 of pet (Refer to ColorLabels dictionary)
- Color2 - Color 2 of pet (Refer to ColorLabels dictionary)
- Color3 - Color 3 of pet (Refer to ColorLabels dictionary)
- MaturitySize - Size at maturity (1 = Small, 2 = Medium, 3 = Large, 4 = Extra Large, 0 = Not Specified)
- FurLength - Fur length (1 = Short, 2 = Medium, 3 = Long, 0 = Not Specified)
- Vaccinated - Pet has been vaccinated (1 = Yes, 2 = No, 3 = Not Sure)
- Dewormed - Pet has been dewormed (1 = Yes, 2 = No, 3 = Not Sure)
- Sterilized - Pet has been spayed / neutered (1 = Yes, 2 = No, 3 = Not Sure)
- Health - Health Condition (1 = Healthy, 2 = Minor Injury, 3 = Serious Injury, 0 = Not Specified)
- Quantity - Number of pets represented in profile
- Fee - Adoption fee (0 = Free)
- State - State location in Malaysia (Refer to StateLabels dictionary)
- RescuerID - Unique hash ID of rescuer
- VideoAmt - Total uploaded videos for this pet
- PhotoAmt - Total uploaded photos for this pet
- Description - Profile write-up for this pet. The primary language used is English, with some in Malay or Chinese.

### What to Predict
Predictor (Adoption Speed) Description: Predict how quickly, if at all, a pet is adopted.

The values are determined in the following way:
0 - Pet was adopted on the same day as it was listed.
1 - Pet was adopted between 1 and 7 days (1st week) after being listed.
2 - Pet was adopted between 8 and 30 days (1st month) after being listed.
3 - Pet was adopted between 31 and 90 days (2nd & 3rd month) after being listed.
4 - No adoption after 100 days of being listed.

### This Notebook...
The data has no missing values, but there are a number of features in text that need to be converted to some numeric value. This notebook performs those changes.

```{r}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
```

```{r}
library(dplyr)
library(reshape)
library(ggplot2)
library(purrr)
library(psych)
library(tidyr)
library(corrplot)
library(forcats)
```

### Load Data
Load the data
```{r echo=FALSE}
# load data
data <- read.csv('./data/TrainingData/traindatawithbreedname.csv')
#data <- read.csv('./data/TestData/test.csv')
head(data,2)
```

### Missing Values Count 
There are no missing values
```{r}
map(data, ~sum(is.na(.))) %>% t()
```

### Show the type of each data
```{r}
str(data)
```

### New features
AgeYears - provided in months this is too many variations.  Decided to convert to new feature of AgeYears and drop Age
```{r}
data$AgeYears = round(data$Age/12, 0)
```

NumColors - derived by counting the number of colors a pet has using the Color1,2, and 3 features
- keep these features, but given there are 7 color categories the value of this feature is questionable in doubt
- create a NumColors feature with a 1,2, or 3 respectively
```{r}
num_colors_vec = c()
for (i in 1:nrow(data)){
  ncolors = 1
  
  color2 <- data[i,8]
  color3 <- data[i,9]
  
  if (color2 > 0){ncolors = ncolors + 1}
  if (color3 > 0){ncolors = ncolors + 1}
  
  num_colors_vec <- c(num_colors_vec, ncolors)
}

data$NumColors = num_colors_vec
```

AllMeds = the sum of Vaccinated, Dewormed, and Sterilized.  Combining these into one feature could potentially reduce
multi-collinearity
```{r}
data$AllMeds = data$Vaccinated + data$Dewormed + data$Sterilized
```

### Remove features 
Remove the following features...
Name - this is a text field and new owners can (and usually do) rename their pets, so removing this feature
Age - replaced with AgeYears (see above)
Breed2 - 10,700 of almost 15,000 rows are populated with 0 (unknown), so this doesn't seem like a good feature to keep
State - initially kept this, but the correlation to AdoptionSpeed is only about 2%.  Decided to remove it
RescuerID - common sense is that this field will not have any predictive value for adoption rate
Description - this will have value in future analysis for NLP, but this will be evaluated differently in another notebook
PetID - same reason as RescuerID

```{r}
data = subset(data, select = -c(Name, Age, Breed2, State, RescuerID, Description, PetID))
```

### Show the updated data type
```{r}
sapply(data,class)
```

#Change categorical variables from integer to factors
```{r}
data <- transform(
  data,
  Type=as.factor(Type),
  Breed1=as.factor(Breed1),
  Gender=as.factor(Gender),
  Color1=as.factor(Color1),
  Color2=as.factor(Color2),
  Color3=as.factor(Color3),
  MaturitySize=as.factor(MaturitySize),
  FurLength=as.factor(FurLength),
  Vaccinated = as.factor(Vaccinated),
  Dewormed = as.factor(Dewormed),
  Sterilized = as.factor(Sterilized),
  Health = as.factor(Health),
  AdoptionSpeed = as.factor(AdoptionSpeed),
  NumColors = as.factor(NumColors)
)
```


```{r}
str(data)
```
Import the color labels to see the names of the colors.

```{r}
colors <- read.csv('./data/color_labels.csv')

glimpse(colors)
```
Checking the levels of `Color1`, `Color2`, and `Color3`

```{r}
levels(data$Color1)
```
```{r}
levels(data$Color2)
```

```{r}
levels(data$Color3)
```

Creating new variables to name the colors.

```{r}
data$ColorName1 <- recode_factor(data$Color1,"1"= "Black", 
                                "2"= "Brown", 
                                "3"= "Golden", 
                                "4"= "Yellow", 
                                "5"= "Cream", 
                                "6"= "Gray", 
                                "7"= "White")
  
```

```{r}
data$ColorName2 <- recode_factor(data$Color2, "0" = "NA",
                                "2"= "Brown", 
                                "3"= "Golden", 
                                "4"= "Yellow", 
                                "5"= "Cream", 
                                "6"= "Gray", 
                                "7"= "White")
```

```{r}
data$ColorName3 <- recode_factor(data$Color3, "0" = "NA",
                                "3"= "Golden", 
                                "4"= "Yellow", 
                                "5"= "Cream", 
                                "6"= "Gray", 
                                "7"= "White")
```


Converting the `char` version of "NA" introduced in `ColorName`s 1-3 to type NA.
```{r}
data[data=="NA"]<-NA
```

### Breed Data

Converting the `breedname` to a factor.
```{r}
data$breedname <- as.factor(data$breedname)
```

Lets check how many dogs and cats we have:
```{r}
table(data$Type)
```

It looks like we have 1262 more dogs than cats, with 8132 dogs and 6861 cats.

Next we bring in the AKC Breed Info table to load details on dog sizes by breed.
```{r}
breed_size <- read.csv('./data/TrainingData/AKC Breed Info.csv')

str(breed_size)
```

Remove one Fox Terrier of the two entries. Both entries have the same size data, only difference is hair type (smooth vs. wire).
```{r}
breed_size <- breed_size %>% 
  slice(-116)

breed_size$height_low_inches <- as.integer(breed_size$height_low_inches)
breed_size$height_high_inches <- as.integer(breed_size$height_high_inches)
```


Using the `breed_size` table, a feature can be created using the [American Kennel Club Breeds by Size](https://www.petplace.com/article/dogs/pet-care/american-kennel-club-akc-breeds-by-size/) breakdown.

Alternatively, here is another breed type [breakdown by size](https://citydogslife.com/small-medium-large-dog-size-guide/).

```{r}
breed_size$avg_weight <- rowMeans(breed_size[,c('weight_low_lbs', 'weight_high_lbs')], na.rm=TRUE)
```

```{r}
breed_size$BreedName <- recode(breed_size$BreedName, "Collie (Rough) & (Smooth)" = "Collie",
                               "Fox Terrier ‰ÛÒ Wirehair" = "Fox Terrier")
```

```{r}
#[row,column]
cs <- sapply(breed_size[c(68,69),],mean)

breed_size<-rbind(breed_size, cs)

breed_size[150,1] = "Cocker Spaniel"
breed_size[68,1] ="American Cocker Spaniel"
breed_size[69,1] ="English Cocker Spaniel"
```

Next we subset our `data` by `Type` to focus on dogs *woof*.

```{r}
dog_data = filter(data, Type == 1)
dog_data = subset(dog_data, select = -c(Type))
```

```{r}
dog_data$breedname <- gsub("Amer ", "American ", dog_data$breedname) 
```

Next we will collapse duplicate Labrador Retriever factors (Black, Chocolate, and Yellow) into one as they are not considered to be separate [Retriever breeds](https://www.akc.org/expert-advice/dog-breeds/retriever-breeds/).

```{r}
dog_data$breedname <- fct_collapse(dog_data$breedname, 'Labrador Retriever' = c("Black Labrador Retriever","Chocolate Labrador Retriever","Yellow Labrador Retriever"))
```

Below are the top 10 breeds where Mixed Breed has a heavy majority with more than half of the dogs being categorized as a mix.

```{r}
table(dog_data$breedname) %>% 
  as.data.frame() %>% 
  arrange(desc(Freq)) %>% 
  top_n(10)
  #subset(Freq!=0)
```

[hypoallergenic](https://www.akc.org/dog-breeds/hypoallergenic-dogs/)

###Output an updated csv 
```{r}
#write.csv(data, './data/TrainingData/train_cleaned.csv',row.names = FALSE)
#write.csv(data, './data/TestData/test_cleaned.csv',row.names = FALSE)
```


